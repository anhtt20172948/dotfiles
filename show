#!/bin/bash
# ============================================================
#  show â€” open a remote file (or folder) automatically
#  Usage: show <abs_path>
#  Example: show /home/user/project/file.txt
# ============================================================

set -e

# Colors and formatting
BOLD='\033[1m'
DIM='\033[2m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
RESET='\033[0m'

# Icons
ICON_CHECK="âœ“"
ICON_CROSS="âœ—"
ICON_SEARCH="ðŸ”"
ICON_SERVER="ðŸ–¥ï¸ "
ICON_FILE="ðŸ“„"
ICON_FOLDER="ðŸ“"
ICON_MOUNT="ðŸ”—"
ICON_ROCKET="ðŸš€"

# Print helpers
print_header() {
  echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
  echo -e "${BOLD}${CYAN}  SHOW - Remote File Viewer${RESET}"
  echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

print_step() {
  echo -e "${BOLD}${BLUE}â–¸${RESET} $1"
}

print_success() {
  echo -e "${GREEN}${ICON_CHECK}${RESET} $1"
}

print_error() {
  echo -e "${RED}${ICON_CROSS}${RESET} $1"
}

print_info() {
  echo -e "${DIM}  â„¹${RESET} $1"
}

print_separator() {
  echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
}

# Spinner for background tasks
spinner() {
  local pid=$1
  local delay=0.1
  local spinstr='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
  while ps -p $pid > /dev/null 2>&1; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    local spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  printf "    \b\b\b\b"
}

print_header

REMOTE_PATH="$1"

# ðŸ”§ Define your servers here
SERVERS=(
  "jupyter"
  "rack"
  "strong"
  "jetson51"
  "jetson52"
)

MOUNT_BASE="/tmp/mnt_show"

# Show supported servers
print_step "Supported servers (${#SERVERS[@]} total):"
for SERVER in "${SERVERS[@]}"; do
  echo -e "  ${DIM}â€¢${RESET} ${CYAN}${SERVER}${RESET}"
done
print_separator

if [[ -z "$REMOTE_PATH" ]]; then
  print_error "No path provided"
  echo -e "${DIM}Usage: show <abs_path>${RESET}"
  echo -e "${DIM}Example: show /home/user/project/file.txt${RESET}"
  exit 1
fi

print_step "Target path: ${MAGENTA}$REMOTE_PATH${RESET}"
print_separator

# Ensure sshfs exists
if ! command -v sshfs >/dev/null 2>&1; then
  print_error "sshfs is not installed"
  exit 1
fi
# --- Find all servers that have the file ---
print_step "Searching across ${#SERVERS[@]} servers..."
FOUND_SERVERS=()
TEMP_DIR=$(mktemp -d)
PIDS=()

# Start all checks in parallel
for i in "${!SERVERS[@]}"; do
  SERVER="${SERVERS[$i]}"
  echo -ne "${DIM}  ${ICON_SEARCH} Checking ${SERVER}...${RESET}\r"
  (
    if ssh -o ConnectTimeout=3 -o LogLevel=ERROR "$SERVER" "[ -e \"$REMOTE_PATH\" ]" 2>/dev/null; then
      echo "$SERVER" > "$TEMP_DIR/$i"
    fi
  ) &
  PIDS+=($!)
done

# Wait for all checks to complete
wait

echo -ne "\033[K" # Clear line

# Collect results in order
for i in "${!SERVERS[@]}"; do
  if [[ -f "$TEMP_DIR/$i" ]]; then
    FOUND_SERVERS+=("$(cat "$TEMP_DIR/$i")")
    print_success "Found on ${GREEN}${BOLD}$(cat "$TEMP_DIR/$i")${RESET}"
  fi
done
rm -rf "$TEMP_DIR"

if [[ ${#FOUND_SERVERS[@]} -eq 0 ]]; then
  print_separator
  print_error "File or directory not found on any configured servers"
  exit 1
fi

print_separator

# --- If multiple servers found, let user choose ---
if [[ ${#FOUND_SERVERS[@]} -gt 1 ]]; then
  echo -e "${YELLOW}${BOLD}Multiple servers found. Please select:${RESET}"
  select FOUND_SERVER in "${FOUND_SERVERS[@]}"; do
    if [[ -n "$FOUND_SERVER" ]]; then
      break
    else
      print_error "Invalid choice. Try again."
    fi
  done
else
  FOUND_SERVER="${FOUND_SERVERS[0]}"
fi

print_step "Selected server: ${GREEN}${BOLD}${ICON_SERVER}${FOUND_SERVER}${RESET}"
print_separator

# --- Prepare mount point ---
SAFE_NAME="${FOUND_SERVER//[@.]/_}"
MOUNT_POINT="${MOUNT_BASE}_${SAFE_NAME}"
mkdir -p "$MOUNT_POINT"

# --- Mount if needed ---
if ! mountpoint -q "$MOUNT_POINT"; then
  print_step "Mounting ${FOUND_SERVER}..."
  sshfs "$FOUND_SERVER":/ "$MOUNT_POINT" -o reconnect,ServerAliveInterval=15,ServerAliveCountMax=3 || {
    print_error "Failed to mount $FOUND_SERVER"
    exit 1
  }
  print_success "Mounted at ${CYAN}$MOUNT_POINT${RESET}"
else
  print_info "Already mounted at ${CYAN}$MOUNT_POINT${RESET}"
fi

# --- Compute local path ---
LOCAL_PATH="${MOUNT_POINT}${REMOTE_PATH}"

if [[ ! -e "$LOCAL_PATH" ]]; then
  print_error "File or directory not found locally after mount"
  exit 1
fi

print_separator

# --- Open function ---
open_item() {
  if [[ -d "$LOCAL_PATH" ]]; then
    print_step "Opening directory ${ICON_FOLDER}"
    print_info "Path: ${CYAN}$LOCAL_PATH${RESET}"
    xdg-open "$LOCAL_PATH" >/dev/null 2>&1 &
    return
  fi

  EXT="${LOCAL_PATH##*.}"
  SIZE=$(du -h "$LOCAL_PATH" | cut -f1)
  print_step "Opening file ${ICON_FILE}"
  print_info "Type: ${MAGENTA}.$EXT${RESET}"
  print_info "Size: ${YELLOW}$SIZE${RESET}"
  print_info "Path: ${CYAN}$LOCAL_PATH${RESET}"
  
  case "$EXT" in
    txt|log|md)
      xdg-open "$LOCAL_PATH" >/dev/null 2>&1 & ;;
    pdf)
      xdg-open "$LOCAL_PATH" >/dev/null 2>&1 & ;;
    jpg|jpeg|png|gif)
      xdg-open "$LOCAL_PATH" >/dev/null 2>&1 & ;;
    doc|docx|xls|xlsx|csv)
      libreoffice "$LOCAL_PATH" >/dev/null 2>&1 & ;;
    py|sh|js|html|css|c|cpp|json|yaml|yml)
      kitty --title "nvim - $LOCAL_PATH" nvim "$LOCAL_PATH" >/dev/null 2>&1 & ;;
    *)
      print_info "Opening with default app..."
      xdg-open "$LOCAL_PATH" >/dev/null 2>&1 & ;;
  esac
}

open_item

# --- Auto-unmount after 10 min ---
(sleep 600 && fusermount -u "$MOUNT_POINT" 2>/dev/null) &

print_separator
print_success "${ICON_ROCKET} Successfully opened!"
print_info "Auto-unmount in ${YELLOW}10 minutes${RESET}"
echo ""
